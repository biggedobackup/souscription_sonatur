{% load static %}
{% load humanize %}

<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Parcelles</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="bg-gray-50 min-h-screen flex flex-col">
    {% include 'tableau_administration/header.html' %}

    <main class="container mx-auto px-4 py-8 flex-grow">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Gestion des Parcelles</h1>
            <div class="flex gap-4">
                <button onclick="openAddModal()" 
                        class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200 flex items-center gap-2">
                    <i class="fas fa-plus"></i>
                    Ajouter une parcelle
                </button>
                <button onclick="openImportModal()" 
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center gap-2">
                    <i class="fas fa-file-import"></i>
                    Importer des parcelles
                </button>
            </div>
        </div>

        <!-- Barre de recherche -->
        <div class="mb-6 max-w-md">
            <form method="GET" class="flex gap-4">
                <div class="flex-1">
                    <div class="relative">
                        <input type="text" 
                               name="search" 
                               value="{{ search_query }}"
                               placeholder="Rechercher une parcelle..." 
                               class="w-full px-3 py-1.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500 pl-7 text-sm">
                        <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-400 text-xs"></i>
                        </div>
                    </div>
                </div>
                <button type="submit" 
                        class="px-3 py-1.5 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-200 flex items-center gap-1 text-sm">
                    <i class="fas fa-search"></i>
                    Rechercher
                </button>
                {% if search_query %}
                <a href="{% url 'tableau_administration:liste_parcelles' %}" 
                   class="px-3 py-1.5 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition duration-200 flex items-center gap-1 text-sm">
                    <i class="fas fa-times"></i>
                    Réinitialiser
                </a>
                {% endif %}
            </form>
        </div>

        {% if messages %}
        <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-4">
            {% for message in messages %}
            <div class="toast-message transform transition-all duration-300 ease-out translate-x-0 opacity-100 flex items-center p-4 mb-4 text-gray-500 bg-white rounded-lg shadow dark:text-gray-400 dark:bg-gray-800" role="alert">
                <div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 
                    {% if message.tags == 'success' %}text-green-500 bg-green-100
                    {% elif message.tags == 'error' %}text-red-500 bg-red-100
                    {% else %}text-blue-500 bg-blue-100{% endif %}
                    rounded-lg">
                    {% if message.tags == 'success' %}
                        <i class="fas fa-check"></i>
                    {% elif message.tags == 'error' %}
                        <i class="fas fa-exclamation"></i>
                    {% else %}
                        <i class="fas fa-info"></i>
                    {% endif %}
                </div>
                <div class="ml-3 text-sm font-normal">{{ message }}</div>
                <button type="button" class="ml-auto -mx-1.5 -my-1.5 bg-white text-gray-400 hover:text-gray-900 rounded-lg p-1.5 hover:bg-gray-100 inline-flex h-8 w-8" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Tableau des parcelles -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Opération</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Site</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Zone</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Section</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Position</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lot</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parcelle</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usage</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Surface</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Coût/m²</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Coût total</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acompte</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reste à payer</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for parcelle in parcelles %}
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if parcelle.operation %}
                                    {{ parcelle.operation.intitule }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">{{ parcelle.code }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">{{ parcelle.site }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">{{ parcelle.zone }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">{{ parcelle.section }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">{{ parcelle.position }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">{{ parcelle.lot }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">{{ parcelle.parcelle }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">{{ parcelle.usage }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">{{ parcelle.surface|intcomma }} m²</td>
                            <td class="px-6 py-4 whitespace-nowrap">{{ parcelle.cout_m2|intcomma }} FCFA</td>
                            <td class="px-6 py-4 whitespace-nowrap">{{ parcelle.cout_total|intcomma }} FCFA</td>
                            <td class="px-6 py-4 whitespace-nowrap">{{ parcelle.acompte|intcomma }} FCFA</td>
                            <td class="px-6 py-4 whitespace-nowrap">{{ parcelle.reste_a_payer|intcomma }} FCFA</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex flex-col gap-1">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full {% if parcelle.actif %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                        Parcelle active : {% if parcelle.actif %}Oui{% else %}Non{% endif %}
                                    </span>
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full {% if parcelle.bloquer %}bg-yellow-100 text-yellow-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                                        Bloqué : {% if parcelle.bloquer %}Oui{% else %}Non{% endif %}
                                    </span>
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full {% if parcelle.paye %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                                        Payé : {% if parcelle.paye %}Oui{% else %}Non{% endif %}
                                    </span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex items-center space-x-2">
                                    <button data-action="view"
                                            data-parcelle="{{ parcelle.id }}"
                                            data-operation="{% if parcelle.operation %}{{ parcelle.operation.intitule }}{% else %}-{% endif %}"
                                            data-code="{{ parcelle.code }}"
                                            data-site="{{ parcelle.site }}"
                                            data-zone="{{ parcelle.zone }}"
                                            data-section="{{ parcelle.section }}"
                                            data-position="{{ parcelle.position }}"
                                            data-lot="{{ parcelle.lot }}"
                                            data-parcelle-num="{{ parcelle.parcelle }}"
                                            data-usage="{{ parcelle.usage }}"
                                            data-surface="{{ parcelle.surface }}"
                                            data-cout-m2="{{ parcelle.cout_m2 }}"
                                            data-cout-total="{{ parcelle.cout_total }}"
                                            data-acompte="{{ parcelle.acompte }}"
                                            data-reste-a-payer="{{ parcelle.reste_a_payer }}"
                                            data-date-ajout="{{ parcelle.date_ajout|date:'d/m/Y H:i' }}"
                                            data-actif="{{ parcelle.actif|yesno:'true,false' }}"
                                            data-bloquer="{{ parcelle.bloquer|yesno:'true,false' }}"
                                            data-paye="{{ parcelle.paye|yesno:'true,false' }}"
                                            class="flex items-center px-2 py-1 bg-blue-100 text-blue-700 rounded-sm hover:bg-blue-200">
                                        <i class="fas fa-eye mr-1"></i>
                                        <span class="text-xs">Voir</span>
                                    </button>
                                    
                                    <button data-action="edit"
                                            data-parcelle="{{ parcelle.id }}"
                                            data-operation="{% if parcelle.operation %}{{ parcelle.operation.id }}{% endif %}"
                                            data-code="{{ parcelle.code }}"
                                            data-site="{{ parcelle.site }}"
                                            data-zone="{{ parcelle.zone }}"
                                            data-section="{{ parcelle.section }}"
                                            data-position="{{ parcelle.position }}"
                                            data-lot="{{ parcelle.lot }}"
                                            data-parcelle-num="{{ parcelle.parcelle }}"
                                            data-usage="{{ parcelle.usage }}"
                                            data-surface="{{ parcelle.surface }}"
                                            data-cout-m2="{{ parcelle.cout_m2 }}"
                                            data-cout-total="{{ parcelle.cout_total }}"
                                            data-acompte="{{ parcelle.acompte }}"
                                            data-reste-a-payer="{{ parcelle.reste_a_payer }}"
                                            data-actif="{{ parcelle.actif|lower }}"
                                            data-bloquer="{{ parcelle.bloquer|lower }}"
                                            data-paye="{{ parcelle.paye|lower }}"
                                            class="flex items-center px-2 py-1 bg-indigo-100 text-indigo-700 rounded-sm hover:bg-indigo-200">
                                        <i class="fas fa-edit mr-1"></i>
                                        <span class="text-xs">Éditer</span>
                                    </button>
                                    
                                    <button data-action="delete"
                                            data-parcelle="{{ parcelle.id }}"
                                            data-code="{{ parcelle.code }}"
                                            class="flex items-center px-2 py-1 bg-red-100 text-red-700 rounded-sm hover:bg-red-200">
                                        <i class="fas fa-trash mr-1"></i>
                                        <span class="text-xs">Supprimer</span>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        <div class="mt-4 flex justify-between items-center">
            <div class="text-sm text-gray-700">
                Affichage de {{ parcelles.start_index }} à {{ parcelles.end_index }} sur {{ parcelles.paginator.count }} parcelles
            </div>
            
            <div class="flex items-center space-x-2">
                {% if parcelles.has_previous %}
                    <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}" 
                       class="px-3 py-2 bg-white border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        <i class="fas fa-angle-double-left"></i>
                    </a>
                    <a href="?page={{ parcelles.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" 
                       class="px-3 py-2 bg-white border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        <i class="fas fa-angle-left"></i>
                    </a>
                {% endif %}

                <span class="px-3 py-2 bg-white border border-gray-300 rounded-md text-sm font-medium text-gray-700">
                    Page {{ parcelles.number }} sur {{ parcelles.paginator.num_pages }}
                </span>

                {% if parcelles.has_next %}
                    <a href="?page={{ parcelles.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" 
                       class="px-3 py-2 bg-white border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        <i class="fas fa-angle-right"></i>
                    </a>
                    <a href="?page={{ parcelles.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}" 
                       class="px-3 py-2 bg-white border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        <i class="fas fa-angle-double-right"></i>
                    </a>
                {% endif %}
            </div>
        </div>

        <!-- Modales (Ajout, Édition, Suppression) -->
        <div id="addModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
            <div class="relative top-10 mx-auto p-6 border w-3/4 max-w-4xl shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 class="text-xl font-medium text-gray-900 mb-6">Ajouter une parcelle</h3>
                    <form id="addForm" method="POST" action="{% url 'tableau_administration:ajouter_parcelle' %}">
                        {% csrf_token %}
                        <div class="grid grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Opération</label>
                                <select name="operation" id="add_operation"
                                        class="w-full px-3 py-2 border rounded-md">
                                    <option value="">Sélectionnez une opération</option>
                                    {% for operation in operations %}
                                        <option value="{{ operation.id }}">{{ operation.intitule }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Code</label>
                                <input type="text" name="code" required 
                                       class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Site</label>
                                <input type="text" name="site" required 
                                       class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Zone</label>
                                <input type="text" name="zone" required 
                                       class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Section</label>
                                <input type="text" name="section" required 
                                       class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Position</label>
                                <input type="text" name="position" required 
                                       class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Lot</label>
                                <input type="text" name="lot" required 
                                       class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Parcelle</label>
                                <input type="text" name="parcelle" required 
                                       class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Usage</label>
                                <input type="text" name="usage" required 
                                       class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Surface (m²)</label>
                                <input type="number" name="surface" id="add_surface" required 
                                       onchange="calculateAddTotals()"
                                       class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Coût au m² (FCFA)</label>
                                <input type="number" name="cout_m2" id="add_cout_m2" required 
                                       onchange="calculateAddTotals()"
                                       class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Acompte (FCFA)</label>
                                <input type="number" name="acompte" id="add_acompte" required 
                                       onchange="calculateAddTotals()"
                                       class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Coût total (FCFA)</label>
                                <input type="number" name="cout_total" id="add_cout_total" required 
                                       class="w-full px-3 py-2 border rounded-md">
                                <p class="mt-1 text-sm text-gray-500">Calculé automatiquement mais modifiable</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Reste à payer (FCFA)</label>
                                <input type="number" name="reste_a_payer" id="add_reste_a_payer" required 
                                       class="w-full px-3 py-2 border rounded-md">
                                <p class="mt-1 text-sm text-gray-500">Calculé automatiquement mais modifiable</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="flex items-center">
                                    <input type="checkbox" name="is_active" id="edit_actif" 
                                           class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                                    <label class="ml-2 block text-sm text-gray-900">Parcelle active</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="is_blocked" id="edit_bloquer" 
                                           class="h-4 w-4 text-yellow-600 focus:ring-yellow-500 border-gray-300 rounded">
                                    <label class="ml-2 block text-sm text-gray-900">Bloquer</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="is_paid" id="edit_paye" 
                                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <label class="ml-2 block text-sm text-gray-900">Payé</label>
                                </div>
                            </div>
                        </div>
                        <div class="mt-5 flex justify-end gap-4">
                            <button type="button" onclick="closeAddModal()" 
                                    class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
                                Annuler
                            </button>
                            <button type="submit" 
                                    class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                                Ajouter
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
            <div class="relative top-10 mx-auto p-6 border w-3/4 max-w-4xl shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 class="text-xl font-medium text-gray-900 mb-6">Modifier une parcelle</h3>
                    <form id="editForm" method="POST">
                        {% csrf_token %}
                        <div class="grid grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Opération</label>
                                <select name="operation" id="edit_operation"
                                        class="w-full px-3 py-2 border rounded-md">
                                    <option value="">Sélectionnez une opération</option>
                                    {% for operation in operations %}
                                        <option value="{{ operation.id }}">{{ operation.intitule }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Code</label>
                                <input type="text" name="code" id="edit_code" required 
                                       class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Site</label>
                                <input type="text" name="site" id="edit_site" required 
                                       class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Zone</label>
                                <input type="text" name="zone" id="edit_zone" required 
                                       class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Section</label>
                                <input type="text" name="section" id="edit_section" required 
                                       class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Position</label>
                                <input type="text" name="position" id="edit_position" required 
                                       class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Lot</label>
                                <input type="text" name="lot" id="edit_lot" required 
                                       class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Parcelle</label>
                                <input type="text" name="parcelle" id="edit_parcelle" required 
                                       class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Usage</label>
                                <input type="text" name="usage" id="edit_usage" required 
                                       class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Surface (m²)</label>
                                <input type="number" name="surface" id="edit_surface" required 
                                       onchange="calculateTotals()"
                                       class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Coût au m² (FCFA)</label>
                                <input type="number" name="cout_m2" id="edit_cout_m2" required 
                                       onchange="calculateTotals()"
                                       class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Acompte (FCFA)</label>
                                <input type="number" name="acompte" id="edit_acompte" required 
                                       onchange="calculateTotals()"
                                       class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Coût total (FCFA)</label>
                                <input type="number" name="cout_total" id="edit_cout_total" required 
                                       class="w-full px-3 py-2 border rounded-md">
                                <p class="mt-1 text-sm text-gray-500">Calculé automatiquement mais modifiable</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Reste à payer (FCFA)</label>
                                <input type="number" name="reste_a_payer" id="edit_reste_a_payer" required 
                                       class="w-full px-3 py-2 border rounded-md">
                                <p class="mt-1 text-sm text-gray-500">Calculé automatiquement mais modifiable</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="flex items-center">
                                    <input type="checkbox" name="is_active" id="edit_actif" 
                                           class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                                    <label class="ml-2 block text-sm text-gray-900">Parcelle active</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="is_blocked" id="edit_bloquer" 
                                           class="h-4 w-4 text-yellow-600 focus:ring-yellow-500 border-gray-300 rounded">
                                    <label class="ml-2 block text-sm text-gray-900">Bloquer</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="is_paid" id="edit_paye" 
                                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <label class="ml-2 block text-sm text-gray-900">Payé</label>
                                </div>
                            </div>
                        </div>
                        <div class="mt-5 flex justify-end gap-4">
                            <button type="button" onclick="closeEditModal()" 
                                    class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
                                Annuler
                            </button>
                            <button type="submit" 
                                    class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                                Enregistrer
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Supprimer une parcelle</h3>
                    <p class="text-gray-600">Êtes-vous sûr de vouloir supprimer la parcelle <span id="delete_parcelle_code" class="font-semibold"></span> ?</p>
                    <div class="mt-5 flex justify-end gap-4">
                        <button onclick="closeDeleteModal()" 
                                class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
                            Annuler
                        </button>
                        <button onclick="confirmDelete()" 
                                class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                            Supprimer
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="viewModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
            <div class="relative top-10 mx-auto p-6 border w-3/4 max-w-4xl shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 class="text-xl font-medium text-gray-900 mb-6">Détails de la parcelle</h3>
                    <div class="grid grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Opération</label>
                            <p id="view_operation" class="text-sm text-gray-900"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Code</label>
                            <p id="view_code" class="text-sm text-gray-900"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Site</label>
                            <p id="view_site" class="text-sm text-gray-900"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Zone</label>
                            <p id="view_zone" class="text-sm text-gray-900"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Section</label>
                            <p id="view_section" class="text-sm text-gray-900"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Position</label>
                            <p id="view_position" class="text-sm text-gray-900"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Lot</label>
                            <p id="view_lot" class="text-sm text-gray-900"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Parcelle</label>
                            <p id="view_parcelle" class="text-sm text-gray-900"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Usage</label>
                            <p id="view_usage" class="text-sm text-gray-900"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Surface</label>
                            <p id="view_surface" class="text-sm text-gray-900"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Coût au m²</label>
                            <p id="view_cout_m2" class="text-sm text-gray-900"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Coût total</label>
                            <p id="view_cout_total" class="text-sm text-gray-900"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Acompte</label>
                            <p id="view_acompte" class="text-sm text-gray-900"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Reste à payer</label>
                            <p id="view_reste_a_payer" class="text-sm text-gray-900"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date d'ajout</label>
                            <p id="view_date_ajout" class="text-sm text-gray-900"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Statuts</label>
                            <div class="mt-1 flex flex-col gap-1">
                                <span id="view_actif" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"></span>
                                <span id="view_bloquer" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"></span>
                                <span id="view_paye" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"></span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-5 flex justify-end">
                        <button onclick="closeViewModal()" 
                                class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
                            Fermer
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="importModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Importer des parcelles</h3>
                    <form id="importForm" method="POST" action="{% url 'tableau_administration:importer_parcelles' %}" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Opération</label>
                                <select name="operation_id" id="import_operation"
                                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                    <option value="">Sélectionnez une opération (optionnel)</option>
                                    {% for operation in operations %}
                                        <option value="{{ operation.id }}">{{ operation.intitule }}</option>
                                    {% endfor %}
                                </select>
                                <p class="mt-1 text-sm text-gray-500">Cette opération sera appliquée à toutes les parcelles importées</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700">Fichier Excel (.xlsx)</label>
                                <input type="file" name="fichier_excel" accept=".xlsx" required
                                       class="mt-1 block w-full text-sm text-gray-500
                                              file:mr-4 file:py-2 file:px-4
                                              file:rounded-md file:border-0
                                              file:text-sm file:font-semibold
                                              file:bg-blue-50 file:text-blue-700
                                              hover:file:bg-blue-100">
                            </div>

                            <div class="text-sm text-gray-500">
                                <p class="font-medium mb-2">Format attendu :</p>
                                <ul class="list-disc pl-5 space-y-1">
                                    <li>code</li>
                                    <li>site</li>
                                    <li>zone</li>
                                    <li>section</li>
                                    <li>position</li>
                                    <li>lot</li>
                                    <li>parcelle</li>
                                    <li>usage</li>
                                    <li>surface</li>
                                    <li>cout_m2</li>
                                    <li>acompte</li>
                                    <li>cout_total (optionnel)</li>
                                    <li>reste_a_payer (optionnel)</li>
                                    <li>operation_id (optionnel, remplacé par la sélection ci-dessus si renseignée)</li>
                                </ul>
                            </div>

                            <div class="flex items-center">
                                <input type="checkbox" name="ignorer_erreurs" id="ignorer_erreurs"
                                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label class="ml-2 block text-sm text-gray-900">
                                    Ignorer les lignes en erreur
                                </label>
                            </div>
                        </div>
                        <div class="mt-5 flex justify-end gap-4">
                            <button type="button" onclick="closeImportModal()" 
                                    class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
                                Annuler
                            </button>
                            <button type="submit" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                Importer
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Script JavaScript -->
        <script>
            let currentParcelleId = null;

            function openAddModal() {
                document.getElementById('addModal').classList.remove('hidden');
            }

            function closeAddModal() {
                document.getElementById('addModal').classList.add('hidden');
            }

            function openEditModal(data) {
                currentParcelleId = data.parcelle;
                const form = document.getElementById('editForm');
                form.action = `{% url 'tableau_administration:modifier_parcelle' 0 %}`.replace('0', data.parcelle);
                
                document.getElementById('edit_operation').value = data.operation || '';
                document.getElementById('edit_code').value = data.code || '';
                document.getElementById('edit_site').value = data.site || '';
                document.getElementById('edit_zone').value = data.zone || '';
                document.getElementById('edit_section').value = data.section || '';
                document.getElementById('edit_position').value = data.position || '';
                document.getElementById('edit_lot').value = data.lot || '';
                document.getElementById('edit_parcelle').value = data.parcelleNum || '';
                document.getElementById('edit_usage').value = data.usage || '';
                document.getElementById('edit_surface').value = data.surface || '';
                document.getElementById('edit_cout_m2').value = data.coutM2 || '';
                document.getElementById('edit_acompte').value = data.acompte || '';
                document.getElementById('edit_cout_total').value = data.coutTotal || '';
                document.getElementById('edit_reste_a_payer').value = data.resteAPayer || '';
                document.getElementById('edit_actif').checked = data.actif === 'true';
                document.getElementById('edit_bloquer').checked = data.bloquer === 'true';
                document.getElementById('edit_paye').checked = data.paye === 'true';
                
                document.getElementById('edit_cout_total').dataset.manuallyEdited = '';
                document.getElementById('edit_reste_a_payer').dataset.manuallyEdited = '';
                
                document.getElementById('editModal').classList.remove('hidden');
            }

            function closeEditModal() {
                document.getElementById('editModal').classList.add('hidden');
            }

            function openDeleteModal(data) {
                currentParcelleId = data.parcelle;
                document.getElementById('delete_parcelle_code').textContent = data.code;
                document.getElementById('deleteModal').classList.remove('hidden');
            }

            function closeDeleteModal() {
                document.getElementById('deleteModal').classList.add('hidden');
            }

            function confirmDelete() {
                if (currentParcelleId) {
                    window.location.href = `{% url 'tableau_administration:supprimer_parcelle' 0 %}`.replace('0', currentParcelleId);
                }
            }

            function openViewModal(data) {
                document.getElementById('view_operation').textContent = data.operation || 'Non spécifié';
                document.getElementById('view_code').textContent = data.code || 'Non spécifié';
                document.getElementById('view_site').textContent = data.site || 'Non spécifié';
                document.getElementById('view_zone').textContent = data.zone || 'Non spécifié';
                document.getElementById('view_section').textContent = data.section || 'Non spécifié';
                document.getElementById('view_position').textContent = data.position || 'Non spécifié';
                document.getElementById('view_lot').textContent = data.lot || 'Non spécifié';
                document.getElementById('view_parcelle').textContent = data.parcelleNum || 'Non spécifié';
                document.getElementById('view_usage').textContent = data.usage || 'Non spécifié';
                document.getElementById('view_surface').textContent = (data.surface || '0') + ' m²';
                document.getElementById('view_cout_m2').textContent = (data.coutM2 || '0') + ' FCFA';
                document.getElementById('view_cout_total').textContent = (data.coutTotal || '0') + ' FCFA';
                document.getElementById('view_acompte').textContent = (data.acompte || '0') + ' FCFA';
                document.getElementById('view_reste_a_payer').textContent = (data.resteAPayer || '0') + ' FCFA';
                document.getElementById('view_date_ajout').textContent = data.dateAjout || 'Non spécifié';
                
                // Gestion des statuts
                const actifSpan = document.getElementById('view_actif');
                if (data.actif === 'true') {
                    actifSpan.textContent = 'Parcelle active : Oui';
                    actifSpan.classList.add('bg-green-100', 'text-green-800');
                    actifSpan.classList.remove('bg-red-100', 'text-red-800');
                } else {
                    actifSpan.textContent = 'Parcelle active : Non';
                    actifSpan.classList.add('bg-red-100', 'text-red-800');
                    actifSpan.classList.remove('bg-green-100', 'text-green-800');
                }

                const bloquerSpan = document.getElementById('view_bloquer');
                if (data.bloquer === 'true') {
                    bloquerSpan.textContent = 'Bloqué : Oui';
                    bloquerSpan.classList.add('bg-yellow-100', 'text-yellow-800');
                    bloquerSpan.classList.remove('bg-gray-100', 'text-gray-800');
                } else {
                    bloquerSpan.textContent = 'Bloqué : Non';
                    bloquerSpan.classList.add('bg-gray-100', 'text-gray-800');
                    bloquerSpan.classList.remove('bg-yellow-100', 'text-yellow-800');
                }

                const payeSpan = document.getElementById('view_paye');
                if (data.paye === 'true') {
                    payeSpan.textContent = 'Payé : Oui';
                    payeSpan.classList.add('bg-green-100', 'text-green-800');
                    bloquerSpan.classList.remove('bg-gray-100', 'text-gray-800');
                } else {
                    payeSpan.textContent = 'Payé : Non';
                    payeSpan.classList.add('bg-gray-100', 'text-gray-800');
                    bloquerSpan.classList.remove('bg-green-100', 'text-green-800');
                }
                
                document.getElementById('viewModal').classList.remove('hidden');
            }

            function closeViewModal() {
                document.getElementById('viewModal').classList.add('hidden');
            }

            function openImportModal() {
                document.getElementById('importModal').classList.remove('hidden');
            }

            function closeImportModal() {
                document.getElementById('importModal').classList.add('hidden');
            }

            // Gestion des clics sur les boutons d'action
            document.addEventListener('click', function(e) {
                const button = e.target.closest('button[data-action]');
                if (!button) return;

                const action = button.dataset.action;
                const data = {
                    parcelle: button.dataset.parcelle,
                    operation: button.dataset.operation,
                    code: button.dataset.code,
                    site: button.dataset.site,
                    zone: button.dataset.zone,
                    section: button.dataset.section,
                    position: button.dataset.position,
                    lot: button.dataset.lot,
                    parcelleNum: button.dataset.parcelleNum,
                    usage: button.dataset.usage,
                    surface: button.dataset.surface,
                    coutM2: button.dataset.coutM2,
                    coutTotal: button.dataset.coutTotal,
                    acompte: button.dataset.acompte,
                    resteAPayer: button.dataset.resteAPayer,
                    dateAjout: button.dataset.dateAjout,
                    actif: button.dataset.actif,
                    bloquer: button.dataset.bloquer,
                    paye: button.dataset.paye
                };

                switch(action) {
                    case 'view':
                        openViewModal(data);
                        break;
                    case 'edit':
                        openEditModal(data);
                        break;
                    case 'delete':
                        openDeleteModal(data);
                        break;
                }
            });

            // Fermeture des modaux en cliquant en dehors
            window.onclick = function(event) {
                const modals = [
                    document.getElementById('addModal'),
                    document.getElementById('editModal'),
                    document.getElementById('deleteModal'),
                    document.getElementById('viewModal'),
                    document.getElementById('importModal')
                ];
                
                modals.forEach(modal => {
                    if (event.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
            }

            // Gestion des messages toast
            document.addEventListener('DOMContentLoaded', function() {
                const toasts = document.querySelectorAll('.toast-message');
                
                toasts.forEach(toast => {
                    setTimeout(() => {
                        toast.classList.add('translate-x-full', 'opacity-0');
                        setTimeout(() => {
                            toast.remove();
                        }, 300);
                    }, 5000);
                });
            });

            function calculateTotals() {
                const surface = parseFloat(document.getElementById('edit_surface').value) || 0;
                const coutM2 = parseFloat(document.getElementById('edit_cout_m2').value) || 0;
                const acompte = parseFloat(document.getElementById('edit_acompte').value) || 0;
                
                // Calcul du coût total
                const coutTotal = surface * coutM2;
                // Ne mettre à jour que si le champ n'a pas été modifié manuellement
                if (!document.getElementById('edit_cout_total').dataset.manuallyEdited) {
                    document.getElementById('edit_cout_total').value = coutTotal;
                }
                
                // Calcul du reste à payer
                const resteAPayer = coutTotal - acompte;
                // Ne mettre à jour que si le champ n'a pas été modifié manuellement
                if (!document.getElementById('edit_reste_a_payer').dataset.manuallyEdited) {
                    document.getElementById('edit_reste_a_payer').value = resteAPayer;
                }
            }

            // Marquer les champs comme modifiés manuellement
            document.getElementById('edit_cout_total').addEventListener('input', function() {
                this.dataset.manuallyEdited = 'true';
            });

            document.getElementById('edit_reste_a_payer').addEventListener('input', function() {
                this.dataset.manuallyEdited = 'true';
            });

            // Fonction de calcul pour le formulaire d'ajout
            function calculateAddTotals() {
                const surface = parseFloat(document.getElementById('add_surface').value) || 0;
                const coutM2 = parseFloat(document.getElementById('add_cout_m2').value) || 0;
                const acompte = parseFloat(document.getElementById('add_acompte').value) || 0;
                
                // Calcul du coût total
                const coutTotal = surface * coutM2;
                // Ne mettre à jour que si le champ n'a pas été modifié manuellement
                if (!document.getElementById('add_cout_total').dataset.manuallyEdited) {
                    document.getElementById('add_cout_total').value = coutTotal;
                }
                
                // Calcul du reste à payer
                const resteAPayer = coutTotal - acompte;
                // Ne mettre à jour que si le champ n'a pas été modifié manuellement
                if (!document.getElementById('add_reste_a_payer').dataset.manuallyEdited) {
                    document.getElementById('add_reste_a_payer').value = resteAPayer;
                }
            }

            // Marquer les champs comme modifiés manuellement dans le formulaire d'ajout
            document.getElementById('add_cout_total').addEventListener('input', function() {
                this.dataset.manuallyEdited = 'true';
            });

            document.getElementById('add_reste_a_payer').addEventListener('input', function() {
                this.dataset.manuallyEdited = 'true';
            });

            // Réinitialiser les marqueurs lors de l'ouverture du modal d'ajout
            function openAddModal() {
                // Réinitialiser le formulaire
                document.getElementById('addForm').reset();
                
                // Réinitialiser les marqueurs de modification manuelle
                document.getElementById('add_cout_total').dataset.manuallyEdited = '';
                document.getElementById('add_reste_a_payer').dataset.manuallyEdited = '';
                
                document.getElementById('addModal').classList.remove('hidden');
            }
        </script>
    </main>

    {% include 'tableau_administration/footer.html' %}
</body>
</html>